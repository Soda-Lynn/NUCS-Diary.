<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NUCS Diary - Write Post</title>

<!-- Quill.js styles -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    padding: 20px;
    background: inherit;  /* theme adaptive */
    color: inherit;
  }

  #editor {
    height: 300px;
    background: inherit;
    color: inherit;
    padding: 10px;
  }

  label { display: block; margin-top: 10px; }
  input { width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box; }
  button { margin-top: 10px; padding: 8px 15px; }
</style>
</head>
<body>

<h1>NUCS Diary - Write Post</h1>

<label>
  Post Title:
  <input type="text" id="postTitle" placeholder="Enter your post title">
</label>

<div id="editor"></div>

<label>
  Preview image URL (optional for Telegram link preview):
  <input type="text" id="ogImage" placeholder="https://example.com/preview.jpg">
</label>

<div>
  <button onclick="publish()">Publish</button>
</div>

<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
<script>
const quill = new Quill('#editor', {
  theme: 'snow',
  placeholder: 'Write your diary post...',
  modules: {
    toolbar: [
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'header': [1, 2, 3, false] }],
      ['link', 'image', 'video'],
      [{ 'list': 'ordered' }, { 'list': 'bullet' }],
      [{ 'align': [] }],
      [{ 'color': [] }],
      [{ 'background': [] }],
      [{ 'size': ['small', false, 'large', 'huge'] }],
      ['clean']
    ]
  }
});

// Custom video handler to insert <video> tag
function customVideoHandler() {
  const fileInput = document.createElement('input');
  fileInput.setAttribute('type', 'file');
  fileInput.setAttribute('accept', 'video/mp4');
  fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (!file) return;
    // Upload file to server or Cloudflare Pages
    const formData = new FormData();
    formData.append('video', file);
    const res = await fetch('/upload-video', { method: 'POST', body: formData });
    const data = await res.json();
    if(data.url){
      const range = quill.getSelection(true);
      const videoHTML = <video controls><source src="${data.url}" type="video/mp4"></video>;
      quill.clipboard.dangerouslyPasteHTML(range.index, videoHTML);
    } else alert('Video upload failed');
  };
  fileInput.click();
}

quill.getModule('toolbar').addHandler('video', customVideoHandler);

async function publish() {
  const html = quill.root.innerHTML;
  const title = document.getElementById('postTitle').value.trim() || "NUCS Diary Post";
  let ogImage = document.getElementById('ogImage').value.trim();

  if (!html || html === '<p><br></p>') return alert("Write something!");

  if (!ogImage) {
    const imgMatch = html.match(/<img[^>]+src="([^">]+)"/i);
    if (imgMatch) ogImage = imgMatch[1];
  }

  const postData = { content: html, title, ogImage };

  try {
    const res = await fetch("/publish", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(postData)
    });

    if (!res.ok) {
      const err = await res.json();
      return alert("Publish failed: " + (err.error || res.status));
    }

    const data = await res.json();
    window.location.href = window.location.origin + data.url;
  } catch (e) {
    alert("Publish error: " + e.message);
  }
}
</script>

</body>
</html>
